<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel | Digital Craft</title>

    <!-- GitHub Pages Redirect Script -->
    <script>
      (function(){
        var redirect = sessionStorage.redirect;
        delete sessionStorage.redirect;
        if (redirect && redirect != location.pathname) {
          history.replaceState(null, null, (location.pathname.endsWith('/') ? location.pathname.slice(0, -1) : location.pathname) + redirect);
        }
      })();
    </script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
    
    <!-- ИЗМЕНЕНИЕ: Ссылка на внешний файл стилей -->
    <link rel="stylesheet" href="style.css">

    <!-- ИЗМЕНЕНИЕ: Добавлены стили для модального окна генератора -->
    <style>
        #generator-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(3, 4, 9, 0.85); z-index: 10001;
            display: none; justify-content: center; align-items: center;
            backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
        }
        #generator-modal.active { display: flex; }
        .generator-content {
            background: var(--color-card); padding: 30px; border-radius: 8px;
            border: 1px solid var(--color-border); width: 90%; max-width: 800px;
            max-height: 90vh; display: flex; flex-direction: column; position: relative;
        }
        #generator-close-btn {
            position: absolute; top: 15px; right: 15px; background: none; border: none;
            color: var(--color-text); font-size: 1.8rem; cursor: pointer;
            transition: all 0.3s; line-height: 1;
        }
        #generator-close-btn:hover { color: var(--color-accent); transform: rotate(90deg); }
        .generator-content h3 { margin-top: 0; }
        .generator-content p { font-size: 0.9rem; opacity: 0.8; margin-bottom: 15px; }
        #generator-output {
            flex-grow: 1; width: 100%; background: rgba(0,0,0,0.4);
            border: 1px solid var(--color-border); color: var(--color-text);
            padding: 15px; border-radius: 4px; font-family: monospace;
            font-size: 0.8rem; resize: none; box-sizing: border-box;
            white-space: pre; word-wrap: normal; overflow-x: scroll;
        }
        .generator-actions { display: flex; gap: 10px; margin-top: 15px; align-self: flex-end; }
    </style>
</head>

<body>
    <noscript><div><img src="https://mc.yandex.ru/watch/103413242" style="position:absolute; left:-9999px;" alt=""></div></noscript>

    <div id="loader"><div class="spinner"></div></div>
    <iframe id="custom-background-iframe" title="Custom Background"></iframe>
    <button class="menu-toggle" aria-label="Toggle menu"><span class="bar"></span><span class="bar"></span><span class="bar"></span></button>
    <div class="nav-overlay"><ul class="nav-menu"></ul></div>
    <main></main>
    <footer class="site-footer" id="site-footer"></footer>
    <div id="admin-panel"><div class="admin-container"><div class="admin-sidebar"><h3>Admin Panel</h3><ul class="admin-tabs"><li class="admin-tab active" data-tab="home">Home Page</li><li class="admin-tab" data-tab="services">Services</li><li class="admin-tab" data-tab="portfolio">Portfolio</li><li class="admin-tab" data-tab="blog">Blog</li><li class="admin-tab" data-tab="contact">Contact</li></ul></div><div class="admin-content"><button id="admin-close-btn" title="Close Admin Panel">×</button><div class="tab-content active" data-tab-content="home"></div><div class="tab-content" data-tab-content="services"></div><div class="tab-content" data-tab-content="portfolio"></div><div class="tab-content" data-tab-content="blog"></div><div class="tab-content" data-tab-content="contact"></div></div></div></div>

    <!-- ИЗМЕНЕНИЕ: HTML для модального окна генератора -->
    <div id="generator-modal">
        <div class="generator-content">
            <button id="generator-close-btn" title="Close Generator">×</button>
            <h3>Generated HTML Code</h3>
            <p>You can copy the code below or download it as a file.</p>
            <textarea id="generator-output" readonly=""></textarea>
            <div class="generator-actions">
                <button id="generator-copy-btn" class="admin-btn">Copy Code</button>
                <a id="generator-download-btn" class="admin-btn" download="generated.html">Download .html file</a>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js';
        import { getFirestore, collection, doc, getDoc, getDocs, writeBatch, setDoc, updateDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js';
        import { getAuth, signInWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js';

        const firebaseConfig = { apiKey: "AIzaSyAT4dDEIDUtzP60ibjahO06P75Q6h95ZN4", authDomain: "razrabotka-b61bc.firebaseapp.com", projectId: "razrabotka-b61bc", storageBucket: "razrabotka-b61bc.firebasestorage.app", messagingSenderId: "394402564794", appId: "1:394402564794:web:f610ffb03e655c600c5083" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // --- DATA CACHE & SEO FUNCTIONS (без изменений) ---
        let siteData = {};
        const initialSiteData = { home: { h1: "Loading...", subtitle: "Please wait", lang: "en" }, services: [], portfolio: [], blog: [], contact: [] };
        function renderSeoTags(data) { /* ... код без изменений ... */ }
        async function seedDatabaseIfEmpty() { /* ... код без изменений ... */ }
        async function loadData() { /* ... код без изменений ... */ const processDocData = (data) => { if (data && typeof data.schemaJsonLd === 'string' && data.schemaJsonLd.trim().startsWith('{')) { try { data.schemaJsonLd = JSON.parse(data.schemaJsonLd); } catch (e) { console.error('Failed to parse schemaJsonLd string:', e); data.schemaJsonLd = {}; } } return data; }; const freshSiteData = {}; try { await seedDatabaseIfEmpty(); const collections = ['services', 'portfolio', 'blog', 'contact']; const dataPromises = [ getDoc(doc(db, 'home', 'content')), ...collections.map(col => getDocs(collection(db, col))) ]; const [homeDoc, ...snapshots] = await Promise.all(dataPromises); freshSiteData.home = homeDoc.exists() ? processDocData(homeDoc.data()) : {}; collections.forEach((col, index) => { freshSiteData[col] = snapshots[index].docs.map(doc => ({ id: doc.id, ...processDocData(doc.data()) })); }); return freshSiteData; } catch (error) { console.error("Error loading data from Firebase:", error); return JSON.parse(JSON.stringify(initialSiteData)); } }

        // --- ROUTER, RENDER LOGIC, etc. (без изменений) ---
        const mainContentEl = document.querySelector('main');
        const defaultLang = 'en';
        const isGitHubPages = window.location.hostname.includes('github.io');
        const repoName = isGitHubPages ? window.location.pathname.split('/')[1] || '' : '';
        const basePath = isGitHubPages && repoName ? `/${repoName}` : '';
        function formatContentHtml(content) { /* ... код без изменений ... */ if (!content) return ''; let processedContent = content.replace(/\r\n/g, '\n'); const blocks = processedContent.split(/\n{2,}/); const html = blocks.map(block => { const trimmedBlock = block.trim(); if (!trimmedBlock) return ''; const youtubeRegex = /^https?:\/\/(?:www\.|m\.)?(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch?v=|watch\?.*&v=|shorts\/))([a-zA-Z0-9_-]{11}).*$/; const imageRegex = /^https?:\/\/[^<>"']+\.(?:jpg|jpeg|png|gif|webp|svg)\s*$/i; const youtubeMatch = trimmedBlock.match(youtubeRegex); const imageMatch = trimmedBlock.match(imageRegex); if (/^<(p|div|h[1-6]|ul|ol|li|blockquote|hr|table|pre)/i.test(trimmedBlock)) { return trimmedBlock; } else if (youtubeMatch && youtubeMatch[1]) { const videoId = youtubeMatch[1]; return `<div class="embedded-video" style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; background: #000; margin: 1.5em 0; border-radius: 4px; border: 1px solid var(--color-border);"><iframe style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;" src="https://www.youtube.com/embed/${videoId}" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>`; } else if (imageMatch) { return `<p style="margin: 1.5em 0;"><img src="${trimmedBlock}" alt="Embedded content" style="max-width: 100%; height: auto; display: block; margin: 0 auto; border-radius: 4px; border: 1px solid var(--color-border);" /></p>`; } else { return `<p>${trimmedBlock.replace(/\n/g, '<br>')}</p>`; } }).join(''); return html; }
        let paragraphObserver; let floatingObserver; let homePageObserver;
        function routeAndRender() { /* ... код без изменений ... */ }
        function renderHomePage() { /* ... код без изменений ... */ }
        function renderDetailPage(collection, slug, lang) { /* ... код без изменений ... */ }
        function renderRelatedPosts(currentCollection, currentSlug, currentLang) { /* ... код без изменений ... */ }
        function updateMetaTags(itemData = {}) { /* ... код без изменений ... */ }
        function renderMenu() { /* ... код без изменений ... */ }
        function renderHero() { /* ... код без изменений ... */ }
        function renderSection(key, title, items) { /* ... код без изменений ... */ }
        function initMobileSliders() { /* ... код без изменений ... */ }
        function createFloatingObserver() { /* ... код без изменений ... */ }
        function initParagraphObservers() { /* ... код без изменений ... */ }
        function initFloatingObservers() { /* ... код без изменений ... */ }
        function initHomePageObservers() { /* ... код без изменений ... */ }
        
        // --- ADMIN PANEL RENDERING LOGIC ---
        function renderAdminPanel() { renderAdminHome(); renderAdminSection('services'); renderAdminSection('portfolio'); renderAdminSection('blog'); renderAdminSection('contact'); };
        function renderAdminHome() {
            const container = document.querySelector('.tab-content[data-tab-content="home"]'); if(!container) return; const data = siteData.home || {}; 
            container.innerHTML = `<div class="admin-section-header"><h2>Home Page Content & SEO</h2></div><div class="admin-item" id="admin-home-item">
                <div class="admin-item-content"> ... </div>
                <div class="admin-item-actions">
                    <button class="admin-btn" data-action="generate-home-html">Generate HTML</button>
                    <button class="admin-btn edit-btn" data-action="edit-home">Edit</button>
                    <button class="admin-btn save-btn" data-action="save-home">Save</button>
                </div>
            </div>`;
            // Код заполнения полей не меняется
            Object.keys(data).forEach(key => { const el = container.querySelector(`#home-${key}`); if (el) { el.value = typeof data[key] === 'object' ? JSON.stringify(data[key], null, 2) : data[key] || ''; }});
        };
        function renderAdminSection(key) {
            const container = document.querySelector(`.tab-content[data-tab-content="${key}"]`); if(!container) return;
            const title = key.charAt(0).toUpperCase() + key.slice(1);
            const itemsHTML = (siteData[key] || []).map(item => `
                <div class="admin-item" data-id="${item.id}" data-key="${key}">
                    <div class="admin-item-content"> ... </div>
                    <div class="admin-item-actions">
                        <button class="admin-btn" data-action="generate-html">Download HTML</button>
                        <button class="admin-btn edit-btn" data-action="edit">Edit</button>
                        <button class="admin-btn save-btn" data-action="save">Save</button>
                        <button class="admin-btn delete-btn" data-action="delete">Delete</button>
                    </div>
                </div>`).join('');
            container.innerHTML = `<div class="admin-section-header"><h2>Manage ${title}</h2><button class="admin-btn" data-action="add" data-key="${key}">+ Add New</button></div>${itemsHTML}`;
            // Код заполнения полей не меняется
            container.querySelectorAll('.admin-item').forEach(itemEl => { const id = itemEl.dataset.id; const itemData = siteData[key].find(i => i.id === id); if(itemData) { for (const prop in itemData) { const input = itemEl.querySelector(`.admin-input-${prop}`); if(input) { input.value = Array.isArray(itemData[prop]) ? itemData[prop].join('\n') : (typeof itemData[prop] === 'object' ? JSON.stringify(itemData[prop], null, 2) : itemData[prop] || ''); } } } });
        };

        // ===================================================================
        // VVV ИЗМЕНЕНИЕ: Новый код для генерации статических страниц VVV
        // ===================================================================
        function getStaticPageTemplate(pageData) {
            const lang = pageData.lang || 'en';
            const pageTitle = pageData.seoTitle || 'Digital Craft';
            const metaDescription = pageData.metaDescription || '';
            const siteUrl = "https://digital-craft-tbilisi.netlify.app"; // ВАЖНО: Укажите ваш домен
            const canonicalPath = pageData.urlSlug ? `/${lang}/${pageData.collection}/${pageData.urlSlug}.html` : '/index.html';
            const canonicalUrl = siteUrl + canonicalPath.replace('/index.html', '/');
            const ogImage = pageData.media?.find(url => !/youtube|vimeo/.test(url)) || pageData.ogImage || '';

            let seoTagsHtml = `
    <title>${pageTitle}</title>
    <meta name="description" content="${metaDescription}">
    <link rel="canonical" href="${canonicalUrl}">
    <meta property="og:title" content="${pageData.ogTitle || pageTitle}">
    <meta property="og:description" content="${pageData.ogDescription || metaDescription}">
    ${ogImage ? `<meta property="og:image" content="${ogImage}">` : ''}`;

            if (pageData.schemaJsonLd && typeof pageData.schemaJsonLd === 'object' && Object.keys(pageData.schemaJsonLd).length > 0) {
                seoTagsHtml += `
    <script type="application/ld+json">${JSON.stringify(pageData.schemaJsonLd)}</script>`;
            }
            
            // Предполагаем, что JS для анимаций будет в отдельном файле
            const staticPageJs = `
                // Код для анимаций, меню, слайдеров и т.д.
                // Этот код должен быть независим от Firebase и загрузки данных.
            `;

            return `<!DOCTYPE html>
<html lang="${lang}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    ${seoTagsHtml.trim()}
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div id="loader"><div class="spinner"></div></div>
    <iframe id="custom-background-iframe" title="Custom Background" style="display: none;"></iframe>
    <button class="menu-toggle" aria-label="Toggle menu"><span class="bar"></span><span class="bar"></span><span class="bar"></span></button>
    <div class="nav-overlay"><ul class="nav-menu"></ul></div>
    <main>${pageData.mainHtmlContent}</main>
    <footer class="site-footer" id="site-footer">© 2025 Digital Craft. All rights reserved.</footer>
    <script>${staticPageJs}</script>
    <script src="/metrika.js" defer></script>
</body>
</html>`;
        }

        function generateDetailPageHtml(item, collectionName) {
            const formattedContent = formatContentHtml(item.mainContent);
            const mainHtmlContent = `<div class="detail-page-header"><h1>${item.h1 || ''}</h1>${item.price ? `<div class="detail-price">${item.price}</div>` : ''}</div><section><div class="detail-content">${formattedContent}</div></section>`;
            const pageData = { ...item, collection: collectionName, mainHtmlContent: mainHtmlContent };
            return getStaticPageTemplate(pageData);
        }

        function generateHomePageHtml() {
            const sections = ['services', 'portfolio', 'blog', 'contact'];
            const sectionsHtml = sections.map(key => {
                const title = { services: 'Our Services', portfolio: 'Our Work', blog: 'Latest Insights', contact: 'Get in Touch' }[key];
                const items = siteData[key] || [];
                if (items.length === 0) return '';
                const itemsHTML = items.map(item => {
                    const itemUrl = `/${item.lang}/${key}/${item.urlSlug}.html`; 
                    const image = (item.media || []).find(url => !/youtube|vimeo/.test(url)) || '';
                    return `<a href="${itemUrl}" class="item-card"><div class="item-card__image" style="background-image: url('${image}')"></div><div class="item-card__content"><h3>${item.title}</h3><div class="card-subtitle">${item.subtitle}</div><p>${item.description}</p></div></a>`
                }).join('');
                return `<section id="${key}"><h2>${title}</h2><div class="item-grid">${itemsHTML}</div></section>`;
            }).join('\n');

            const heroHtml = `<div id="hero" class="hero"><h1>${siteData.home.h1 || ''}</h1><div class="hero-subtitle-container"><p>${siteData.home.subtitle || ''}</p></div></div>`;
            const pageData = { ...siteData.home, mainHtmlContent: heroHtml + sectionsHtml };
            return getStaticPageTemplate(pageData);
        }

        function showAndHandleGeneratedCode(code, filename) {
            const modal = document.getElementById('generator-modal');
            const output = document.getElementById('generator-output');
            const downloadBtn = document.getElementById('generator-download-btn');
            
            output.value = code.trim();
            downloadBtn.download = filename;
            
            // Создаем "Blob" - бинарный объект из нашего текста для скачивания
            const blob = new Blob([code], { type: 'text/html' });
            // Удаляем старую ссылку, чтобы избежать утечек памяти
            if (downloadBtn.href) {
                URL.revokeObjectURL(downloadBtn.href);
            }
            // Создаем новую временную URL для скачивания
            downloadBtn.href = URL.createObjectURL(blob);
            
            modal.style.display = 'flex';
        }
        // ===================================================================
        
        async function handleAdminActions(e) {
            const target = e.target;
            const action = target.dataset.action;
            if (!action) return;
            
            // ИЗМЕНЕНИЕ: Обработка кнопок генерации
            if (action === 'generate-home-html') {
                const html = generateHomePageHtml();
                showAndHandleGeneratedCode(html, 'index.html');
                return;
            }
            if (action === 'generate-html') {
                const itemEl = target.closest('.admin-item');
                const key = itemEl.dataset.key;
                const id = itemEl.dataset.id;
                const item = siteData[key]?.find(d => d.id === id);
                if(item) {
                    const html = generateDetailPageHtml(item, key);
                    const filename = `${item.urlSlug || 'page'}.html`;
                    showAndHandleGeneratedCode(html, filename);
                } else {
                    alert('Error: Item data not found.');
                }
                return;
            }

            const itemEl = target.closest('.admin-item');
            const setEditingState = (el, isEditing) => { el.classList.toggle('is-editing', isEditing); el.querySelectorAll('input, textarea, select').forEach(input => input.disabled = !isEditing); };
            try {
                // ... остальной код handleAdminActions без изменений ...
            } catch(error) { console.error("Admin action failed:", error); alert("An error occurred."); }
        };
        
        // --- EVENT LISTENERS & APP INIT ---
        function initStaticEventListeners() { 
            // ... код без изменений ...
            document.getElementById('generator-close-btn').addEventListener('click', () => {
                const modal = document.getElementById('generator-modal');
                const downloadBtn = document.getElementById('generator-download-btn');
                // Очищаем ссылку для скачивания при закрытии
                if (downloadBtn.href) {
                    URL.revokeObjectURL(downloadBtn.href);
                    downloadBtn.href = "#";
                }
                modal.style.display = 'none';
            });
            document.getElementById('generator-copy-btn').addEventListener('click', () => {
                const output = document.getElementById('generator-output');
                navigator.clipboard.writeText(output.value).then(() => {
                    alert('Code copied to clipboard!');
                }).catch(err => {
                    console.error('Copy failed', err);
                    alert('Could not copy text.');
                });
            });
        }
        function applyCustomBackground(item = null) { /* ... код без изменений ... */ }
        function initApp() { /* ... код без изменений ... */ }

        window.addEventListener('DOMContentLoaded', initApp);
    </script>
    <script src="metrika.js" defer></script>
</body>
</html>