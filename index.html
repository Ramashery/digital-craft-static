<!DOCTYPE html>
<!-- lang будет установлен динамически -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- SEO и OG мета-теги будут вставлены здесь динамически -->
    <title>Digital Craft | Portfolio</title>
    <meta name="description" content="Professional websites for small businesses">

    <!-- ДОБАВЛЕННЫЙ СКРИПТ ДЛЯ КОРРЕКТНОЙ РАБОТЫ НА GITHUB PAGES -->
    <script>
      (function(){
        var redirect = sessionStorage.redirect;
        delete sessionStorage.redirect;
        if (redirect && redirect != location.pathname) {
          history.replaceState(null, null, (location.pathname.endsWith('/') ? location.pathname.slice(0, -1) : location.pathname) + redirect);
        }
      })();
    </script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <!-- НОВЫЙ СКРИПТ ДЛЯ АУТЕНТИФИКАЦИИ -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>

    <!-- Three.js -->
    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.165.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.165.0/examples/jsm/"
        }
    }
    </script>

    <style>
        /* --- Global Variables --- */
        :root {
            --color-bg: #030409;
            --color-text: #FFFFFF;
            --color-accent: #b8d8e8;
            --color-card: rgba(25, 29, 45, 0.4);
            --color-border: rgba(184, 216, 232, 0.2);
            --font-main: 'Cormorant Garamond', serif;
            --header-height: 80px;
        }

        /* --- Base Styles --- */
        body { margin: 0; padding: 0; font-family: var(--font-main); background-color: var(--color-bg); color: var(--color-text); -webkit-font-smoothing: antialiased; overflow-x: hidden; line-height: 1.6; }
        h1, h2, h3 { font-weight: 600; letter-spacing: 0.5px; }
        /* ИЗМЕНЕНИЕ 1: Добавлен адаптивный размер для H2 */
        h2 { font-size: clamp(1.8rem, 1.5rem + 1.5vw, 2.5rem); }
        a { color: var(--color-accent); text-decoration: none; }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--color-bg); display: flex; justify-content: center; align-items: center; z-index: 10000; transition: opacity 0.5s ease-out; }
        .spinner { width: 50px; height: 50px; border: 3px solid var(--color-accent); border-radius: 50%; border-top-color: transparent; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        #webgl-canvas { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 0; }
        
        #custom-background-iframe {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            border: none;
            z-index: 0;
            display: none;
        }
        
        main { position: relative; z-index: 2; max-width: 1200px; margin: 0 auto; padding: 100px 30px; transition: opacity 0.5s ease-out, transform 0.5s ease-out; }
        body.nav-is-open main { opacity: 0; transform: translateY(20px); pointer-events: none; }

        /* --- Animation System --- */
        section { margin-bottom: 120px; perspective: 1000px; }
        .animated-container {
            opacity: 0;
            transform: translateY(50px) rotateX(-20deg);
            transition: all 0.8s cubic-bezier(0.19, 1, 0.22, 1);
        }
        .animated-container.active {
            opacity: 1;
            transform: none;
        }

        /* --- Generic Cards --- */
        .item-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 30px; margin-top: 40px; }
        .item-card { display: flex; flex-direction: column; background: var(--color-card); border: 1px solid var(--color-border); border-radius: 8px; overflow: hidden; transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); }
        .item-card:hover { transform: translateY(-10px) scale(1.02) !important; border-color: var(--color-accent); box-shadow: 0 10px 30px rgba(184, 216, 232, 0.3); }
        .item-card__image { aspect-ratio: 4 / 3; background: linear-gradient(135deg, rgba(184, 216, 232, 0.1), rgba(25, 29, 45, 0.7)); background-size: cover; background-position: center; opacity: 1; transition: opacity 0.8s ease-in-out; position: relative; overflow: hidden; }
        .item-card__content { padding: 25px; }
        /* ИЗМЕНЕНИЕ 2: Скорректирован размер заголовка в карточке */
        .item-card h3 { margin: 0 0 10px; font-size: 1.3rem; transition: color 0.3s ease-out; color: var(--color-text); }
        .item-card:hover h3 { color: var(--color-accent); }
        .item-card .card-subtitle { display: block; margin-bottom: 15px; opacity: 0.8; font-size: 0.9rem; color: var(--color-text); }
        /* ИЗМЕНЕНИЕ 3: Увеличен текст описания в карточке */
        .item-card p { margin: 0; font-size: 1.05rem; opacity: 0.9; color: var(--color-text); }
        
        /* --- Modern Menu --- */
        .menu-toggle { position: fixed; top: 30px; right: 30px; z-index: 1000; background: transparent; border: none; padding: 0; cursor: pointer; width: 30px; height: 24px; display: flex; flex-direction: column; justify-content: space-between; transition: transform 0.4s; }
        .menu-toggle:hover { transform: scale(1.1); }
        .menu-toggle .bar { background: #FFFFFF; height: 2px; width: 100%; transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1); transform-origin: right; }
        .menu-toggle.is-active .bar:nth-child(1) { transform: translateY(11px) rotate(-45deg); background: var(--color-accent); }
        .menu-toggle.is-active .bar:nth-child(2) { opacity: 0; }
        .menu-toggle.is-active .bar:nth-child(3) { transform: translateY(-11px) rotate(45deg); background: var(--color-accent); }
        .nav-overlay { position: fixed; top: 0; right: -100%; width: 400px; height: 100vh; background: var(--color-card); backdrop-filter: blur(10px); z-index: 999; transition: right 0.6s cubic-bezier(0.77, 0, 0.175, 1); overflow: hidden; }
        .nav-overlay.is-active { right: 0; }
        .nav-menu { padding: 100px 40px; list-style: none; margin: 0; }
        .nav-menu li { margin-bottom: 25px; opacity: 0; transform: translateX(30px); transition: all 0.4s ease-out; }
        .nav-overlay.is-active .nav-menu li { opacity: 1; transform: translateX(0); }
        .nav-menu li:nth-child(1) { transition-delay: 0.1s; } .nav-menu li:nth-child(2) { transition-delay: 0.2s; } .nav-menu li:nth-child(3) { transition-delay: 0.3s; } .nav-menu li:nth-child(4) { transition-delay: 0.4s; } .nav-menu li:nth-child(5) { transition-delay: 0.5s; } .nav-menu li:nth-child(6) { transition-delay: 0.6s; }
        .nav-menu a { color: var(--color-text); font-size: 1.8rem; position: relative; padding-bottom: 5px; transition: all 0.3s ease-out; }
        .nav-menu a:hover { color: var(--color-accent); transform: translateX(5px); }
        .nav-menu a::after { content: ''; position: absolute; bottom: 0; left: 0; width: 0; height: 1px; background: var(--color-accent); transition: width 0.4s; }
        .nav-menu a:hover::after { width: 100%; }

        /* --- Hero Section --- */
        .hero { min-height: 90vh; display: flex; flex-direction: column; justify-content: center; }
        .hero h1 { font-size: clamp(2.5rem, 8vw, 4.5rem); margin: 0 0 20px; line-height: 1.1; font-weight: 700; text-shadow: 0 0 15px rgba(184, 216, 232, 0.4); }
        .hero p { font-size: 1.4rem; max-width: 600px; margin-bottom: 40px; }

        /* --- Detail Page Styles --- */
        .service-header { text-align: center; margin-bottom: 60px; }
        .service-header h1 { font-size: clamp(2.5rem, 7vw, 4rem); margin: 0 0 10px; line-height: 1.1; font-weight: 700; text-shadow: 0 0 15px rgba(184, 216, 232, 0.4); }
        .service-price { font-size: 1.2rem; color: var(--color-accent); letter-spacing: 1px; opacity: 0.9; }
        .service-main-image { width: 100%; height: auto; max-height: 450px; border-radius: 8px; object-fit: cover; border: 1px solid var(--color-border); margin-bottom: 40px; }
        /* ИЗМЕНЕНИЕ 4: Улучшенный адаптивный размер для основного текста */
        .service-content { font-size: clamp(1.1rem, 1rem + 0.5vw, 1.25rem); opacity: 0.95; max-width: 800px; margin: 0 auto; }
        .service-content p { margin-bottom: 1.5em; }
        .service-content b, .service-content strong { color: var(--color-accent); font-weight: 600; }
        .service-content a { text-decoration: underline; }
        .service-gallery { margin-top: 60px; }
        .service-gallery h2 { border-bottom: 1px solid var(--color-border); padding-bottom: 10px; margin-bottom: 30px; }
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .gallery-grid img { width: 100%; height: auto; border-radius: 4px; border: 1px solid var(--color-border); }
        .gallery-grid iframe { width: 100%; aspect-ratio: 16 / 9; border: 1px solid var(--color-border); border-radius: 4px; }
        
        .site-footer {
            position: relative;
            z-index: 2;
            text-align: center;
            padding: 20px 30px;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.5);
            margin-top: -60px;
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
        }

        /* --- Admin Panel Styles --- */
        #admin-panel { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(3, 4, 9, 0.95); z-index: 10000; display: none; overflow-y: auto; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
        #admin-panel.active { display: block; }
        .admin-container { display: flex; min-height: 100vh; }
        .admin-sidebar { width: 250px; background: rgba(25, 29, 45, 0.8); padding: 30px; border-right: 1px solid var(--color-border); position: sticky; top: 0; height: 100vh; }
        .admin-sidebar h3 { margin-top: 0; }
        .admin-sidebar ul { list-style: none; padding: 0; }
        .admin-sidebar ul li { margin-bottom: 10px; }
        .admin-content { flex: 1; padding: 40px; }
        .admin-tabs { list-style: none; padding: 0; }
        .admin-tab { padding: 10px 0; cursor: pointer; transition: all 0.3s; }
        .admin-tab.active { color: var(--color-accent); font-weight: bold; }
        .admin-tab:not(.active):hover { color: var(--color-accent); transform: translateX(5px); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        #admin-close-btn { position: absolute; top: 25px; right: 25px; background: none; border: none; color: var(--color-text); font-size: 2rem; cursor: pointer; transition: all 0.3s; line-height: 1; }
        #admin-close-btn:hover { color: var(--color-accent); transform: rotate(90deg); }
        .admin-section-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--color-border); padding-bottom: 15px; margin-bottom: 30px; }
        .admin-item { background: var(--color-card); padding: 20px; border-radius: 8px; border: 1px solid var(--color-border); margin-bottom: 20px; }
        .admin-item-content { display: grid; grid-template-columns: 1fr; gap: 15px; }
        .admin-item-content h4 { margin: 15px 0 0; border-top: 1px solid var(--color-border); padding-top: 15px; color: var(--color-accent); }
        .admin-item label { font-size: 0.9rem; opacity: 0.8; margin-bottom: -10px; }
        .admin-item input, .admin-item textarea, .admin-item select { width: 100%; background: rgba(0,0,0,0.2); border: 1px solid var(--color-border); color: var(--color-text); padding: 10px; border-radius: 4px; font-family: inherit; font-size: 1rem; transition: all 0.3s; box-sizing: border-box; }
        .admin-item input:disabled, .admin-item textarea:disabled, .admin-item select:disabled { background: transparent; border-color: transparent; color: var(--color-text); padding-left: 0; -webkit-appearance: none; -moz-appearance: none; appearance: none; }
        .admin-item input:focus, .admin-item textarea:focus, .admin-item select:focus { border-color: var(--color-accent); background: rgba(0,0,0,0.4); }
        .admin-item textarea { min-height: 80px; resize: vertical; line-height: 1.6; }
        .admin-item-actions { display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end; }
        .admin-btn { padding: 8px 16px; border: 1px solid var(--color-accent); background: rgba(184, 216, 232, 0.1); color: var(--color-accent); border-radius: 4px; cursor: pointer; transition: all 0.3s; }
        .admin-btn:hover { background: rgba(184, 216, 232, 0.3); color: var(--color-text); }
        .admin-btn.delete-btn { border-color: #e57373; color: #e57373; }
        .admin-btn.delete-btn:hover { background: rgba(229, 115, 115, 0.3); color: var(--color-text); }
        .admin-btn.save-btn { display: none; }
        .admin-item.is-editing .edit-btn { display: none; }
        .admin-item.is-editing .save-btn { display: inline-block; }
        .admin-item.is-editing input, .admin-item.is-editing textarea, .admin-item.is-editing select { padding-left: 10px; }
        .admin-item.is-editing select { -webkit-appearance: menulist; -moz-appearance: menulist; appearance: menulist; }

        /* --- Responsive & Reduced Motion --- */
        @media (prefers-reduced-motion: reduce) { *, *::before, *::after { animation-duration: 0.01ms !important; animation-iteration-count: 1 !important; transition-duration: 0.01ms !important; scroll-behavior: auto !important; } .animated-container { opacity: 1; transform: none; transition: none; } }
        @media (max-width: 768px) {
            .animated-container { transform: translateY(30px) rotateX(-10deg); }
            .nav-overlay { width: 100%; } .hero h1 { font-size: 2.5rem; } .item-grid { grid-template-columns: 1fr; } .admin-container { flex-direction: column; } .admin-sidebar { width: 100%; border-right: none; border-bottom: 1px solid var(--color-border); position: static; height: auto; } .admin-content { padding: 20px; } }
        @media (max-width: 480px) { main { padding: 60px 15px; } section { margin-bottom: 60px; } .hero h1 { font-size: 2rem; } .nav-menu { padding: 80px 20px; } .nav-menu a { font-size: 1.5rem; } }
    </style>
</head>
<body>
    <noscript><div><img src="https://mc.yandex.ru/watch/103413242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

    <div id="loader"><div class="spinner"></div></div>

    <canvas id="webgl-canvas"></canvas>
    <iframe id="custom-background-iframe" title="Custom Background"></iframe>

    <button class="menu-toggle" aria-label="Toggle menu">
        <span class="bar"></span><span class="bar"></span><span class="bar"></span>
    </button>

    <div class="nav-overlay">
        <ul class="nav-menu"></ul>
    </div>

    <main></main>
    
    <footer class="site-footer" id="site-footer"></footer>

    <div id="admin-panel">
        <div class="admin-container">
            <div class="admin-sidebar">
                <h3>Admin Panel</h3>
                <ul class="admin-tabs">
                    <li class="admin-tab active" data-tab="home">Home Page</li>
                    <li class="admin-tab" data-tab="services">Services</li>
                    <li class="admin-tab" data-tab="portfolio">Portfolio</li>
                    <li class="admin-tab" data-tab="blog">Blog</li>
                    <li class="admin-tab" data-tab="contact">Contact</li>
                </ul>
            </div>
            <div class="admin-content">
                <button id="admin-close-btn" title="Close Admin Panel">&times;</button>
                <div class="tab-content active" data-tab-content="home"></div>
                <div class="tab-content" data-tab-content="services"></div>
                <div class="tab-content" data-tab-content="portfolio"></div>
                <div class="tab-content" data-tab-content="blog"></div>
                <div class="tab-content" data-tab-content="contact"></div>
            </div>
        </div>
    </div>
    
    <script type="module">
        import * as THREE from 'three';
        
        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
          apiKey: "AIzaSyAT4dDEIDUtzP60ibjahO06P75Q6h95ZN4",
          authDomain: "razrabotka-b61bc.firebaseapp.com",
          projectId: "razrabotka-b61bc",
          storageBucket: "razrabotka-b61bc.firebasestorage.app",
          messagingSenderId: "394402564794",
          appId: "1:394402564794:web:f610ffb03e655c600c5083"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth(); // ИНИЦИАЛИЗАЦИЯ СЕРВИСА AUTH

        // --- LOCAL DATA CACHE & INITIAL DATA ---
        let siteData = {};
        const initialSiteData = {};
        
        // HOME PAGE - Главная страница (EN, основной язык)
        initialSiteData.home = {
            h1: "Web Development & SEO in Tbilisi",
            subtitle: "We create high-performance websites for Georgian businesses that attract clients and boost revenue. Modern design, cutting-edge technology, and measurable results.",
            lang: "en",
            seoTitle: "Web Development & SEO Services in Tbilisi, Georgia | Digital Craft",
            metaDescription: "Professional website development and SEO for small and medium businesses in Tbilisi. Get a fast, modern, and results-driven website. Contact us for a free consultation!",
            schemaJsonLd: {
                "@context": "https://schema.org",
                "@type": "LocalBusiness",
                "name": "Digital Craft Tbilisi",
                "image": "https://images.unsplash.com/photo-1551288049-bebda4e38f71?q=80&w=1200&h=630&auto=format&fit=crop",
                "@id": "https://digital-craft-tbilisi.netlify.app/",
                "url": "https://digital-craft-tbilisi.netlify.app/",
                "telephone": "+995 591 102 653",
                "priceRange": "$$",
                "address": {
                    "@type": "PostalAddress",
                    "addressLocality": "Tbilisi",
                    "addressCountry": "GE"
                },
                "description": "Custom web development and SEO optimization services for businesses in Tbilisi, Georgia.",
                "openingHoursSpecification": {
                    "@type": "OpeningHoursSpecification",
                    "dayOfWeek": [
                        "Monday",
                        "Tuesday",
                        "Wednesday",
                        "Thursday",
                        "Friday"
                    ],
                    "opens": "10:00",
                    "closes": "19:00"
                }
            },
            ogTitle: "Digital Craft: Websites That Drive Business Growth in Tbilisi",
            ogDescription: "From stunning landing pages to robust e-commerce solutions, we build websites that deliver results for Georgian businesses.",
            ogImage: "https://images.unsplash.com/photo-1551288049-bebda4e38f71?q=80&w=1200&h=630&auto=format&fit=crop",
            backgroundHtml: ""
        };

        // SERVICES - Услуги (EN, KA)
        initialSiteData.services = [
            {id: 'service-web-en', lang: 'en', urlSlug: 'custom-web-development-tbilisi', title: 'Custom Web Development', subtitle: 'For Georgian Businesses', description: 'From landing pages to complex web applications. Fast, secure, and mobile-friendly.', h1: 'Web Development Services in Tbilisi', mainContent: 'We build websites that are not just beautiful, but are powerful business tools. Our process includes:\n\n<ul><li><b>Strategy & Consulting:</b> We dive deep into your business goals.</li><li><b>UI/UX Design:</b> Creating intuitive and engaging user experiences.</li><li><b>Modern Technologies:</b> Using fast and reliable frameworks (React, Vue, etc.).</li><li><b>Full Responsiveness:</b> Perfect display on all devices - desktops, tablets, and phones.</li><li><b>Basic SEO Setup:</b> Your site will be ready for search engines from day one.</li></ul>\n\nWe believe a good website is an investment that pays for itself.', price: 'From 2000 GEL', media: ['https://images.unsplash.com/photo-1555066931-4365d14bab8c?q=80&w=2070&auto=format&fit=crop'], mainImageAlt: 'Laptop with code on the screen.', seoTitle: 'Custom Web Development in Tbilisi, Georgia | Digital Craft', metaDescription: 'Get a professional, fast, and SEO-ready website for your business in Tbilisi. We specialize in custom solutions that drive growth.', schemaJsonLd: {}, backgroundHtml: ""},
            {id: 'service-web-ka', lang: 'ka', urlSlug: 'veb-gverdebis-damzadeba-tbilisi', title: 'ვებ გვერდების დამზადება', subtitle: 'ქართული ბიზნესისთვის', description: 'ლენდინგებიდან რთულ ვებ აპლიკაციებამდე. სწრაფი, უსაფრთხო და მობილურზე მორგებული.', h1: 'ვებ გვერდების დამზადების სერვისი თბილისში', mainContent: 'ჩვენ ვქმნით ვებსაიტებს, რომლებიც არა მხოლოდ ლამაზია, არამედ მძლავრი ბიზნეს ინსტრუმენტია. ჩვენი პროცესი მოიცავს:\n\n<ul><li><b>სტრატეგია და კონსულტაცია:</b> ჩვენ ღრმად ვიკვლევთ თქვენს ბიზნეს მიზნებს.</li><li><b>UI/UX დიზაინი:</b> ინტუიციური და მიმზიდველი მომხმარებლის გამოცდილების შექმნა.</li><li><b>თანამედროვე ტექნოლოგიები:</b> ვიყენებთ სწრაფ და საიმედო ფრეიმვორკებს (React, Vue და ა.შ.).</li><li><b>სრული რესპონსიულობა:</b> იდეალური ჩვენება ყველა მოწყობილობაზე - დესკტოპზე, პლანშეტსა და ტელეფონზე.</li><li><b>საბაზისო SEO მომზადება:</b> თქვენი საიტი პირველივე დღიდან მზად იქნება საძიებო სისტემებისთვის.</li></ul>\n\nჩვენ გვჯერა, რომ კარგი ვებსაიტი არის ინვესტიცია, რომელიც თავის თავს ამოიღებს.', price: '2000 ლარიდან', media: ['https://images.unsplash.com/photo-1555066931-4365d14bab8c?q=80&w=2070&auto=format&fit=crop'], mainImageAlt: 'ლეპტოპი კოდით ეკრანზე.', seoTitle: 'ვებ გვერდების დამზადება თბილისში | Digital Craft', metaDescription: 'მიიღეთ პროფესიონალური, სწრაფი და SEO-ზე მორგებული ვებსაიტი თქვენი ბიზნესისთვის თბილისში. ჩვენ ვспециализиრდებით ინდივიდუალურ გადაწყვეტილებებზე.', schemaJsonLd: {}, backgroundHtml: ""},
            {id: 'service-seo-en', lang: 'en', urlSlug: 'seo-optimization-tbilisi', title: 'SEO Optimization', subtitle: 'Get Found on Google', description: 'Technical SEO, on-page optimization, and content strategy to rank higher in search results.', h1: 'Search Engine Optimization (SEO) in Tbilisi', mainContent: 'A beautiful website is useless if no one can find it. Our SEO services are designed to increase your visibility and attract targeted traffic.\n\n<b>What we do:</b>\n\n<ul><li><b>Technical SEO Audit:</b> Fixing errors that prevent Google from ranking you.</li><li><b>Keyword Research:</b> Finding the exact phrases your customers are searching for.</li><li><b>On-Page SEO:</b> Optimizing titles, texts, and images for search engines.</li><li><b>Local SEO:</b> Making sure your business appears in local searches and on Google Maps in Tbilisi.</li><li><b>Content Strategy:</b> Helping you create content that attracts and engages your audience.</li></ul>', price: 'From 800 GEL / month', media: ['https://images.unsplash.com/photo-1559526324-c1f275fbfa32?q=80&w=2070&auto=format&fit=crop'], mainImageAlt: 'Charts and graphs showing SEO progress.', seoTitle: 'SEO Services in Tbilisi for Small Business | Digital Craft', metaDescription: 'Boost your Google rankings with our professional SEO services in Tbilisi. We help Georgian businesses attract more clients through organic search.', schemaJsonLd: {}, backgroundHtml: ""},
            {id: 'service-seo-ka', lang: 'ka', urlSlug: 'seo-optimizacia-tbilisi', title: 'SEO ოპტიმიზაცია', subtitle: 'გამოჩნდით Google-ში', description: 'ტექნიკური SEO, on-page ოპტიმიზაცია და კონტენტ სტრატეგია საძიებო სისტემებში მაღალი პოზიციებისთვის.', h1: 'საძიებო სისტემების ოპტიმიზაცია (SEO) თბილისში', mainContent: 'ლამაზი ვებსაიტი უსარგებლოა, თუ მას ვერავინ პოულობს. ჩვენი SEO სერვისები შექმნილია თქვენი ხილვადობის გასაზრდელად და მიზნობრივი ტრაფიკის მოსაზიდად.\n\n<b>რას ვაკეთებთ:</b>\n\n<ul><li><b>ტექნიკური SEO აუდიტი:</b> იმ შეცდომების გამოსწორება, რომლებიც ხელს უშლის Google-ს თქვენს რეიტინგში.</li><li><b>საკვანძო სიტყვების კვლევა:</b> იმ ზუსტი ფრაზების პოვნა, რომლებსაც თქვენი მომხმარებლები ეძებენ.</li><li><b>On-Page SEO:</b> სათაურების, ტექსტებისა და სურათების ოპტიმიზაცია საძიებო სისტემებისთვის.</li><li><b>ლოკალური SEO:</b> თქვენი ბიზნესის გამოჩენა ლოკალურ ძიებაში და Google Maps-ზე თბილისში.</li><li><b>კონტენტ სტრატეგია:</b> დაგეხმარებით შექმნათ კონტენტი, რომელიც იზიდავს და ანგაჟირებს თქვენს აუდიტორიას.</li></ul>', price: 'თვეში 800 ლარიდან', media: ['https://images.unsplash.com/photo-1559526324-c1f275fbfa32?q=80&w=2070&auto=format&fit=crop'], mainImageAlt: 'SEO პროგრესის ამსახველი გრაფიკები.', seoTitle: 'SEO სერვისები თბილისში მცირე ბიზნესისთვის | Digital Craft', metaDescription: 'გააუმჯობესეთ თქვენი Google რეიტინგი ჩვენი პროფესიონალური SEO სერვისებით თბილისში. ჩვენ ვეხმარებით ქართულ ბიზნესს მეტი კლიენტის მოზიდვაში.', schemaJsonLd: {}, backgroundHtml: ""}
        ];

        initialSiteData.portfolio = [
            {id: 'portfolio-1', lang: 'en', urlSlug: 'case-study-restaurant-website', title: 'Tbilisi Restaurant "Saperavi"', subtitle: 'Website & Online Booking', description: 'A complete website redesign for a popular restaurant in Tbilisi, resulting in a 40% increase in online reservations.', h1: 'Case Study: "Saperavi" Restaurant Website Redesign', mainContent: '<b>The Challenge:</b> The restaurant had an outdated website that was not mobile-friendly and had a complicated booking process.\n\n<b>The Solution:</b> We developed a new, visually stunning website with a focus on high-quality photos of the food and interior. A simple, one-click reservation system was integrated directly into the homepage.\n\n<b>The Results:</b>\n<ul><li>40% increase in online bookings within the first 3 months.</li><li>Mobile traffic bounce rate decreased by 60%.</li><li>The website now ranks on the first page of Google for "best khinkali in Tbilisi".</li></ul>', price: 'Project Budget: 3500 GEL', media: ['https://images.unsplash.com/photo-1555396273-367ea4eb4db5?q=80&w=2070&auto=format&fit=crop'], mainImageAlt: 'Modern website for a Georgian restaurant Saperavi.', seoTitle: 'Case Study: Saperavi Restaurant Website | Digital Craft Tbilisi', metaDescription: 'See how we helped a Tbilisi restaurant increase their online bookings by 40% with a new, modern website and smart design.', schemaJsonLd: {}, backgroundHtml: "" }
        ];

        initialSiteData.blog = [
            { id: 'article-1', lang: 'en', urlSlug: 'why-your-tbilisi-business-needs-a-website', title: '5 Reasons Your Tbilisi Business Needs a Website in 2024', subtitle: 'Business Growth', description: 'Discover why a professional website is the best investment for any small business in Georgia today.', h1: '5 Reasons Your Tbilisi Business Needs a Professional Website', mainContent: 'In today\'s digital age, not having a website means losing clients to your competitors. Here are five key reasons why your local business in Tbilisi needs a strong online presence:\n\n1. <b>Credibility and Trust:</b> A professional website instantly boosts your credibility.\n2. <b>24/7 Availability:</b> Your website works for you around the clock, even when you\'re asleep.\n3. <b>Attract New Customers:</b> People in Tbilisi are searching for your services on Google right now.\n4. <b>Showcase Your Work:</b> A website is the perfect portfolio for your products and services.\n5. <b>Save Time:</b> Answer frequently asked questions (FAQs), show your location, and list your services automatically.', price: '', media: ['https://images.unsplash.com/photo-1524758631624-e2822e304c36?q=80&w=2070&auto=format&fit=crop'], mainImageAlt: 'A person working on a laptop in a modern office.', seoTitle: 'Why Your Tbilisi Business Needs a Website | Digital Craft Blog', metaDescription: 'Learn the top 5 reasons why a professional website is crucial for the growth and success of any small business in Tbilisi, Georgia.', schemaJsonLd: {}, backgroundHtml: "" }
        ];

        initialSiteData.contact = [
            { id: 'contact-1', lang: 'en', urlSlug: 'contact-us', title: 'Let\'s Build Something Great', subtitle: "Contact me in Tbilisi", description: "Ready to start a project or just want to ask a question? I'm here to help. Click to get in touch.", h1: "Contact Digital Craft", mainContent: "I'm always open to discussing new projects, creative ideas, or opportunities to be part of your vision. Feel free to reach out to me.\n\n<ul><li><b>Email:</b> <a href='mailto:your.email@example.com'>your.email@example.com</a></li><li><b>Phone / Telegram:</b> <a href='tel:+995591102653'>+995 591 102 653</a></li><li><b>Based in:</b> Tbilisi, Georgia</li></ul>\n\nLet's work together to create a website that helps your business grow.", price: '', media: [], mainImageAlt: '', seoTitle: 'Contact for Web Development & SEO in Tbilisi | Digital Craft', metaDescription: 'Contact us for a free consultation on web development, e-commerce, or SEO services in Tbilisi, Georgia.', schemaJsonLd: {}, backgroundHtml: '' }
        ];
        
        // --- Определение базового пути для GitHub Pages ---
        const isGitHubPages = window.location.hostname.includes('github.io');
        const repoName = isGitHubPages ? window.location.pathname.split('/')[1] || '' : '';
        const basePath = isGitHubPages && repoName ? `/${repoName}` : '';

        // --- DATA MANAGEMENT ---
        async function seedDatabaseIfEmpty() { 
            const homeDoc = await db.collection('home').doc('content').get(); 
            if (!homeDoc.exists) { 
                console.log("Database is empty. Seeding with initial data..."); 
                const batch = db.batch(); 
                batch.set(db.collection('home').doc('content'), initialSiteData.home); 
                for (const key of ['services', 'portfolio', 'blog', 'contact']) { 
                    initialSiteData[key].forEach(item => { 
                        const { id, ...data } = item;
                        batch.set(db.collection(key).doc(id), data); 
                    }); 
                } 
                await batch.commit(); 
                console.log("Database seeded successfully."); 
            } 
        };
        
        async function loadData() {
            const freshSiteData = {};
            try {
                await seedDatabaseIfEmpty(); 

                const collections = ['services', 'portfolio', 'blog', 'contact'];
                const dataPromises = [
                    db.collection('home').doc('content').get(),
                    ...collections.map(col => db.collection(col).get())
                ];

                const [homeDoc, ...snapshots] = await Promise.all(dataPromises);

                const processDocData = (data) => {
                    if (data && typeof data.schemaJsonLd === 'string' && data.schemaJsonLd.trim().startsWith('{')) {
                        try {
                            data.schemaJsonLd = JSON.parse(data.schemaJsonLd);
                        } catch (e) {
                            console.error('Failed to parse schemaJsonLd string:', e);
                            data.schemaJsonLd = {};
                        }
                    }
                    return data;
                };

                freshSiteData.home = homeDoc.exists ? processDocData(homeDoc.data()) : {};
                collections.forEach((col, index) => {
                    freshSiteData[col] = snapshots[index].docs.map(doc => ({ id: doc.id, ...processDocData(doc.data()) }));
                });
                
                return freshSiteData;

            } catch (error) {
                console.error("Error loading data from Firebase:", error);
                return JSON.parse(JSON.stringify(initialSiteData)); // В случае ошибки возвращаем локальные данные
            }
        }
        
        // --- ROUTER AND RENDER LOGIC ---
        const mainContentEl = document.querySelector('main');
        const defaultLang = 'en';
        
        function formatContentHtml(content) {
            if (!content) return '';
            let processedContent = content.replace(/\r\n/g, '\n').trim();
            const blocks = processedContent.split('\n\n');
            
            const html = blocks.map(block => {
                const trimmedBlock = block.trim();
                if (!trimmedBlock) return '';

                const youtubeRegex = /^https?:\/\/(?:www\.|m\.)?(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch?v=|watch\?.*&v=|shorts\/))([a-zA-Z0-9_-]{11}).*$/;
                const imageRegex = /^https?:\/\/[^<>"']+\.(?:jpg|jpeg|png|gif|webp|svg)\s*$/i;

                const youtubeMatch = trimmedBlock.match(youtubeRegex);
                const imageMatch = trimmedBlock.match(imageRegex);
                
                if (youtubeMatch && youtubeMatch[1]) {
                    const videoId = youtubeMatch[1];
                    return `<div class="embedded-video" style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; background: #000; margin: 1.5em 0; border-radius: 4px; border: 1px solid var(--color-border);"><iframe style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;" src="https://www.youtube.com/embed/${videoId}" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>`;
                } 
                else if (imageMatch) {
                    return `<p style="margin: 1.5em 0;"><img src="${trimmedBlock}" alt="Embedded content" style="max-width: 100%; height: auto; display: block; margin: 0 auto; border-radius: 4px; border: 1px solid var(--color-border);" /></p>`;
                } 
                else if (/^<(p|div|h[1-6]|ul|ol|li|blockquote|hr|table|pre)/i.test(trimmedBlock)) {
                    return trimmedBlock;
                } 
                else {
                    return `<p>${trimmedBlock.replace(/\n/g, '<br>')}</p>`;
                }
            }).join('');

            return html;
        }
        
        function routeAndRender() { 
            // Сообщаем Метрике о просмотре новой "виртуальной" страницы
            if (typeof ym === 'function') {
                ym(103413242, 'hit', window.location.href);
            }
            
            const path = window.location.pathname; 
            const pathWithoutBase = path.startsWith(basePath) ? path.substring(basePath.length) || '/' : path;
            
            const detailPageRegex = /^\/(?:([a-z]{2})\/)?(services|portfolio|blog|contact)\/([a-zA-Z0-9-]+)\/?$/;
            const match = pathWithoutBase.match(detailPageRegex);
            
            const footer = document.getElementById('site-footer');
            footer.style.display = 'none';

            if (match) { 
                const [, lang, collection, slug] = match;
                const currentLang = lang || defaultLang;
                renderDetailPage(collection, slug, currentLang);
            } else { 
                renderHomePage(); 
                footer.style.display = 'block';
            } 
        };

        function renderHomePage() { 
            mainContentEl.innerHTML = `<section id="hero" class="hero"></section><section id="services"></section><section id="portfolio"></section><section id="blog"></section><section id="contact"></section>`; 
            document.getElementById('admin-panel').style.display = ''; 
            applyCustomBackground(); 
            renderHomePageMeta(); 
            renderHero(); 
            
            renderSection('services', 'Our Services', siteData.services); 
            renderSection('portfolio', 'Our Work', siteData.portfolio); 
            renderSection('blog', 'Latest Insights', siteData.blog); 
            renderSection('contact', 'Get in Touch', siteData.contact);

            initIntersectionObservers(); 
            renderAdminPanel(); 
        };

        function renderDetailPage(collection, slug, lang) {
            const item = siteData[collection]?.find(d => d.urlSlug === slug && d.lang === lang);
            if (!item) {
                mainContentEl.innerHTML = `<section class="service-header"><h1>404 - Not Found</h1><p>The page you were looking for does not exist.</p><a href="${basePath || '/'}">Go back home</a></section>`;
                document.title = "404 Not Found | Digital Craft";
                applyCustomBackground();
                return;
            }
            document.getElementById('admin-panel').style.display = 'none';
            document.documentElement.lang = lang;
            applyCustomBackground(item);
            updateMetaTags(item);
            
            const formattedContent = formatContentHtml(item.mainContent);
            
            mainContentEl.innerHTML = `
                <section>
                    <div class="service-header animated-container">
                        <h1>${item.h1 || ''}</h1>
                        ${item.price ? `<div class="service-price">${item.price}</div>` : ''}
                    </div>
                    <div class="service-content animated-container">${formattedContent}</div>
                </section>`;
            
            initIntersectionObservers();
        }

        // --- DYNAMIC META TAGS & SEO HELPERS ---
        function updateMetaTags(data = {}) {
            document.querySelectorAll('meta[name="description"], meta[property^="og:"], script[type="application/ld+json"]').forEach(el => el.remove()); 
            document.title = data.seoTitle || siteData.home.seoTitle || "Digital Craft"; 
            const createMeta = (attr, key, value) => { if(value){ const meta = document.createElement('meta'); meta.setAttribute(attr, key); meta.content = value; document.head.appendChild(meta); }}; 
            createMeta('name', 'description', data.metaDescription || siteData.home.metaDescription); 
            createMeta('property', 'og:title', data.ogTitle || data.seoTitle || siteData.home.ogTitle); 
            createMeta('property', 'og:description', data.ogDescription || data.metaDescription || siteData.home.ogDescription); 
            const ogImage = data.media?.find(url => !/youtube|vimeo/.test(url)) || data.ogImage || siteData.home.ogImage; 
            if (ogImage) createMeta('property', 'og:image', ogImage); 
            
            if (data.schemaJsonLd && typeof data.schemaJsonLd === 'object' && Object.keys(data.schemaJsonLd).length > 0) {
                const script = document.createElement('script');
                script.type = 'application/ld+json';
                script.textContent = JSON.stringify(data.schemaJsonLd);
                document.head.appendChild(script);
            }
        };
        function renderHomePageMeta() { updateMetaTags(siteData.home); document.documentElement.lang = siteData.home?.lang || 'en'; };

        // --- RENDER FUNCTIONS ---
        function renderMenu() {
            const menuEl = document.querySelector('.nav-menu');
            if (!menuEl) return;
            const menuItems = [
                { label: 'Home', href: `${basePath}/#hero` },
                { label: 'Services', href: `${basePath}/#services` },
                { label: 'Portfolio', href: `${basePath}/#portfolio` },
                { label: 'Blog', href: `${basePath}/#blog` },
                { label: 'Contact', href: `${basePath}/#contact` }
            ];

            menuEl.innerHTML = menuItems.map(item => `
                <li><a href="${item.href}">${item.label}</a></li>
            `).join('');
        }

        function renderHero() { const { h1, subtitle } = siteData.home; document.getElementById('hero').innerHTML = `<h1 class="animated-container">${h1 || ''}</h1><p class="animated-container">${subtitle || ''}</p>`;};
        
        function renderSection(key, title, items) { 
            const section = document.getElementById(key); 
            if (!section) return; 
            const itemsHTML = (items || []).map(item => {
                const langPrefix = item.lang ? `/${item.lang}` : '';
                const itemUrl = `${basePath}${langPrefix}/${key}/${item.urlSlug}`;
                return `<a href="${itemUrl}" class="item-card animated-container"><div class="item-card__image" style="background-image: url('${(item.media || []).find(url => !/youtube|vimeo/.test(url)) || ''}')"></div><div class="item-card__content"><h3>${item.title}</h3><div class="card-subtitle">${item.subtitle}</div><p>${item.description}</p></div></a>`
            }).join(''); 
            section.innerHTML = `<div class="animated-container"><h2>${title}</h2></div><div class="item-grid">${itemsHTML}</div>`; 
        };
        
        // --- ADMIN PANEL FUNCTIONS ---
        function renderAdminPanel() { 
            renderAdminHome(); 
            renderAdminSection('services'); 
            renderAdminSection('portfolio'); 
            renderAdminSection('blog'); 
            renderAdminSection('contact'); 
        };
        function renderAdminHome() { 
            const container = document.querySelector('.tab-content[data-tab-content="home"]'); 
            if(!container) return; 
            const data = siteData.home || {}; 
            container.innerHTML = `<div class="admin-section-header"><h2>Home Page Content & SEO</h2></div><div class="admin-item" id="admin-home-item"><div class="admin-item-content"><h4>Visible Content</h4><label for="home-h1">Main Header (H1)</label><input type="text" id="home-h1" value="${data.h1 || ''}" disabled><label for="home-subtitle">Subtitle</label><textarea id="home-subtitle" rows="3" disabled>${data.subtitle || ''}</textarea><h4>Critical SEO</h4><label for="home-lang">Language (e.g., en, ru)</label><input type="text" id="home-lang" value="${data.lang || 'en'}" disabled><label for="home-seoTitle">SEO Title Tag (&lt; 60 chars)</label><input type="text" id="home-seoTitle" value="${data.seoTitle || ''}" disabled><label for="home-metaDescription">Meta Description (&lt; 160 chars)</label><textarea id="home-metaDescription" rows="3" disabled>${data.metaDescription || ''}</textarea><h4>Schema.org for Organization</h4><label>JSON-LD Code</label><textarea id="home-schemaJsonLd" rows="8" disabled>${typeof data.schemaJsonLd === 'object' ? JSON.stringify(data.schemaJsonLd, null, 2) : data.schemaJsonLd || '{}'}</textarea><h4>Social Media Sharing (Open Graph)</h4><label for="home-ogTitle">OG Title</label><input type="text" id="home-ogTitle" value="${data.ogTitle || ''}" disabled><label for="home-ogDescription">OG Description</label><textarea id="home-ogDescription" rows="3" disabled>${data.ogDescription || ''}</textarea><label for="home-ogImage">OG Image URL (1200x630px recommended)</label><input type="text" id="home-ogImage" value="${data.ogImage || ''}" disabled><h4>Custom Background</h4><label for="home-backgroundHtml">Custom Background HTML/JS/CSS (leave empty for default animation)</label><textarea id="home-backgroundHtml" rows="10" disabled>${data.backgroundHtml || ''}</textarea></div><div class="admin-item-actions"><button class="admin-btn edit-btn" data-action="edit-home">Edit</button><button class="admin-btn save-btn" data-action="save-home">Save</button></div></div>`;
        };
        
        function renderAdminSection(key) { 
            const container = document.querySelector(`.tab-content[data-tab-content="${key}"]`); 
            if(!container) return; 
            const title = key.charAt(0).toUpperCase() + key.slice(1); 
            const itemsHTML = (siteData[key] || []).map(item => `
            <div class="admin-item" data-id="${item.id}" data-key="${key}">
                <div class="admin-item-content">
                    <h4>Card Content (On Home Page)</h4>
                    <label>Card Title</label><input type="text" class="admin-input-title" value="${item.title || ''}" disabled>
                    <label>Card Subtitle / Date</label><input type="text" class="admin-input-subtitle" value="${item.subtitle || ''}" disabled>
                    <label>Card Description</label><textarea class="admin-input-description" rows="3" disabled>${item.description || ''}</textarea>
                    
                    <h4>Detailed Page Content</h4>
                    <label>Language</label>
                    <select class="admin-input-lang" disabled>
                        <option value="en" ${item.lang === 'en' ? 'selected' : ''}>English (en)</option>
                        <option value="ru" ${item.lang === 'ru' ? 'selected' : ''}>Русский (ru)</option>
                        <option value="ka" ${item.lang === 'ka' ? 'selected' : ''}>Georgian (ka)</option>
                    </select>
                    <label>Page URL Slug</label><input type="text" class="admin-input-urlSlug" value="${item.urlSlug || ''}" disabled>
                    <label>Page Main Header (H1)</label><input type="text" class="admin-input-h1" value="${item.h1 || ''}" disabled>
                    <label>Price / Budget</label><input type="text" class="admin-input-price" value="${item.price || ''}" disabled>
                    <label>Main Page Content (Supports HTML and paragraph breaks)</label><textarea class="admin-input-mainContent" rows="8" disabled>${item.mainContent || ''}</textarea>
                    <label>Media (URLs, one per line)</label><textarea class="admin-input-media" rows="4" disabled>${(item.media || []).join('\n')}</textarea>
                    <label>Main Image Alt Text</label><input type="text" class="admin-input-mainImageAlt" value="${item.mainImageAlt || ''}" disabled>
                    
                    <h4>SEO & Metadata</h4>
                    <label>SEO Title Tag</label><input type="text" class="admin-input-seoTitle" value="${item.seoTitle || ''}" disabled>
                    <label>Meta Description</label><textarea class="admin-input-metaDescription" rows="3" disabled>${item.metaDescription || ''}</textarea>
                    <label>Schema.org JSON-LD</label><textarea class="admin-input-schemaJsonLd" rows="5" disabled>${typeof item.schemaJsonLd === 'object' ? JSON.stringify(item.schemaJsonLd, null, 2) : item.schemaJsonLd || '{}'}</textarea>
                    
                    <h4>Custom Background</h4>
                    <label>Custom Page Background HTML/JS/CSS</label><textarea class="admin-input-backgroundHtml" rows="6" disabled>${item.backgroundHtml || ''}</textarea>
                </div>
                <div class="admin-item-actions">
                    <button class="admin-btn edit-btn" data-action="edit">Edit</button>
                    <button class="admin-btn save-btn" data-action="save">Save</button>
                    <button class="admin-btn delete-btn" data-action="delete">Delete</button>
                </div>
            </div>`).join(''); 
            container.innerHTML = `<div class="admin-section-header"><h2>Manage ${title}</h2><button class="admin-btn" data-action="add" data-key="${key}">+ Add New</button></div>${itemsHTML}`;
        };
        async function handleAdminActions(e) {
            const target = e.target;
            const action = target.dataset.action;
            if (!action) return;
            const itemEl = target.closest('.admin-item');
            const setEditingState = (el, isEditing) => {
                el.classList.toggle('is-editing', isEditing);
                el.querySelectorAll('input, textarea, select').forEach(input => input.disabled = !isEditing);
            };
            try {
                if (action === 'edit-home') { setEditingState(itemEl, true); return; }
                if (action === 'save-home') {
                    setEditingState(itemEl, false);
                    let schemaValue = itemEl.querySelector('#home-schemaJsonLd').value;
                    try { schemaValue = JSON.parse(schemaValue); } catch(err) { console.error("Invalid JSON in home schema", err); alert("Error: Invalid JSON in Schema field."); return; }

                    const updatedData = {
                        h1: itemEl.querySelector('#home-h1').value,
                        subtitle: itemEl.querySelector('#home-subtitle').value,
                        lang: itemEl.querySelector('#home-lang').value,
                        seoTitle: itemEl.querySelector('#home-seoTitle').value,
                        metaDescription: itemEl.querySelector('#home-metaDescription').value,
                        schemaJsonLd: schemaValue,
                        ogTitle: itemEl.querySelector('#home-ogTitle').value,
                        ogDescription: itemEl.querySelector('#home-ogDescription').value,
                        ogImage: itemEl.querySelector('#home-ogImage').value,
                        backgroundHtml: itemEl.querySelector('#home-backgroundHtml').value,
                    };
                    await db.collection('home').doc('content').update(updatedData);
                    await loadData().then(freshData => { siteData = freshData; routeAndRender(); });
                    alert('Home page updated!');
                    return;
                }
                
                const key = target.dataset.key || itemEl.dataset.key;
                const id = itemEl ? itemEl.dataset.id : null;
                switch(action) {
                    case 'edit': setEditingState(itemEl, true); break;
                    case 'save': {
                        setEditingState(itemEl, false);
                        let schemaValue = itemEl.querySelector('.admin-input-schemaJsonLd').value;
                        try { schemaValue = JSON.parse(schemaValue); } catch(err) { console.error("Invalid JSON in item schema", err); alert("Error: Invalid JSON in Schema field."); return; }

                        const updatedData = {
                            lang: itemEl.querySelector('.admin-input-lang').value,
                            title: itemEl.querySelector('.admin-input-title').value,
                            subtitle: itemEl.querySelector('.admin-input-subtitle').value,
                            description: itemEl.querySelector('.admin-input-description').value,
                            urlSlug: itemEl.querySelector('.admin-input-urlSlug').value.trim(),
                            h1: itemEl.querySelector('.admin-input-h1').value,
                            price: itemEl.querySelector('.admin-input-price').value,
                            mainContent: itemEl.querySelector('.admin-input-mainContent').value,
                            media: itemEl.querySelector('.admin-input-media').value.split('\n').map(s => s.trim()).filter(Boolean),
                            mainImageAlt: itemEl.querySelector('.admin-input-mainImageAlt').value,
                            seoTitle: itemEl.querySelector('.admin-input-seoTitle').value,
                            metaDescription: itemEl.querySelector('.admin-input-metaDescription').value,
                            schemaJsonLd: schemaValue,
                            backgroundHtml: itemEl.querySelector('.admin-input-backgroundHtml').value,
                        };
                        await db.collection(key).doc(id).update(updatedData);
                        await loadData().then(freshData => { siteData = freshData; routeAndRender(); });
                        alert('Item saved!');
                        break;
                    }
                    case 'delete':
                        if (confirm('Are you sure you want to delete this item?')) {
                            await db.collection(key).doc(id).delete();
                            await loadData().then(freshData => { siteData = freshData; routeAndRender(); });
                            alert('Item deleted!');
                        }
                        break;
                    case 'add':
                        const newId = `${key.slice(0, -1)}-${Date.now()}`;
                        const newTitle = 'New Item Title';
                        const newSlug = newTitle.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
                        const newItemData = {
                            lang: defaultLang,
                            urlSlug: newSlug,
                            title: newTitle,
                            subtitle: 'New Subtitle',
                            description: 'A short description for the card.',
                            h1: newTitle,
                            mainContent: 'Full content for the detailed page.\n\nHTML and paragraph breaks are supported!',
                            price: '',
                            media: [],
                            mainImageAlt: '',
                            seoTitle: newTitle,
                            metaDescription: '',
                            schemaJsonLd: {},
                            backgroundHtml: ''
                        };
                        await db.collection(key).doc(newId).set(newItemData);
                        await loadData().then(freshData => { siteData = freshData; routeAndRender(); });
                        alert('New item added. You can now edit it.');
                        break;
                }
            } catch(error) { console.error("Admin action failed:", error); alert("An error occurred. Please check the console."); }
        };

        // --- ANIMATION LOGIC ---
        let observer;
        function activateContainer(container) { 
            if (container.classList.contains('active')) return; 
            container.classList.add('active'); 
        };
        
        function initIntersectionObservers() { 
            if (observer) observer.disconnect(); 
            observer = new IntersectionObserver((entries, obs) => { 
                entries.forEach(entry => { 
                    if (entry.isIntersecting) { 
                        const section = entry.target; 
                        const containers = section.querySelectorAll('.animated-container'); 
                        containers.forEach((container, index) => { 
                            setTimeout(() => activateContainer(container), index * 150); 
                        }); 
                        obs.unobserve(section); 
                    } 
                }); 
            }, { threshold: 0.1 }); 
            document.querySelectorAll("main > section").forEach(section => observer.observe(section)); 
        };

        // --- THREE.JS SCENE ---
        let defaultAnimationEnabled = true;
        let animationFrameId;
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000); 
        camera.position.z = 5; 
        const canvas = document.getElementById("webgl-canvas"); 
        const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true }); 
        renderer.setSize(window.innerWidth, window.innerHeight); 
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); 
        scene.add(new THREE.AmbientLight(0x404040, 2)); 
        const pointLight1 = new THREE.PointLight(0x00aaff, 30, 20); 
        pointLight1.position.set(5, 5, 5); 
        scene.add(pointLight1); 
        const crystalGroup = new THREE.Group(); 
        scene.add(crystalGroup); 
        let crystalMaterial = new THREE.ShaderMaterial({ uniforms: { time: { value: 0 }, color1: { value: new THREE.Color(0xb8d8e8) }, color2: { value: new THREE.Color(0x1d2a3a) }, }, vertexShader: `varying vec3 vNormal; varying vec3 vPosition; void main() { vNormal = normalize(normalMatrix * normal); vPosition = position; gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0); }`, fragmentShader: `uniform float time; uniform vec3 color1; uniform vec3 color2; varying vec3 vNormal; float snoise(vec3 v){ const vec2 C = vec2(1.0/6.0, 1.0/3.0) ; const vec4 D = vec4(0.0, 0.5, 1.0, 2.0); vec3 i = floor(v + dot(v, C.yyy) ); vec3 x0 = v - i + dot(i, C.xxx) ; vec3 g = step(x0.yzx, x0.xyz); vec3 l = 1.0 - g; vec3 i1 = min( g.xyz, l.zxy ); vec3 i2 = max( g.xyz, l.zxy ); vec3 x1 = x0 - i1 + C.xxx; vec3 x2 = x0 - i2 + C.yyy; vec3 x3 = x0 - D.yyy; i = mod(i, 289.0); vec4 p = mod(((i.z + vec4(0.0, i1.z, i2.z, 1.0 ))*34.0+1.0)* (i.z + vec4(0.0, i1.z, i2.z, 1.0 )) + i.y + vec4(0.0, i1.y, i2.y, 1.0 ), 289.0); p = mod(((p)*34.0+1.0)*(p) + i.x + vec4(0.0, i1.x, i2.x, 1.0 ), 289.0); vec4 j = p - 49.0 * floor(p * (1.0/7.0) * (1.0/7.0)); vec4 x_ = floor(j * (1.0/7.0)); vec4 y_ = floor(j - 7.0 * x_ ); vec4 x = x_ * (2.0/7.0) - 1.0 + (1.0/7.0); vec4 y = y_ * (2.0/7.0) - 1.0 + (1.0/7.0); vec4 h = 1.0 - abs(x) - abs(y); vec4 b0 = vec4( x.xy, y.xy ); vec4 b1 = vec4( x.zw, y.zw ); vec4 s0 = floor(b0)*2.0 + 1.0; vec4 s1 = floor(b1)*2.0 + 1.0; vec4 sh = -step(h, vec4(0.0)); vec4 a0 = b0.xzyw + s0.xzyw*sh.xxyy ; vec4 a1 = b1.xzyw + s1.xzyw*sh.zzww ; vec3 p0 = vec3(a0.xy,h.x); vec3 p1 = vec3(a0.zw,h.y); vec3 p2 = vec3(a1.xy,h.z); vec3 p3 = vec3(a1.zw,h.w); vec4 norm = inversesqrt(vec4(dot(p0,p0), dot(p1,p1), dot(p2,p2), dot(p3,p3))); p0 *= norm.x; p1 *= norm.y; p2 *= norm.z; p3 *= norm.w; vec4 m = max(0.6 - vec4(dot(x0,x0), dot(x1,x1), dot(x2,x2), dot(x3,x3)), 0.0); m = m * m; return 42.0 * dot( m*m, vec4( dot(p0,x0), dot(p1,x1), dot(p2,x2), dot(p3,x3) ) ); } void main() { float noise = snoise(vNormal * 3.0 + time * 0.1); vec3 baseColor = mix(color1, color2, vNormal.y * 0.5 + 0.5); float fresnel = pow(1.0 - abs(dot(vNormal, vec3(0.0, 0.0, 1.0))), 3.0); vec3 finalColor = baseColor + fresnel * vec3(0.8, 0.9, 1.0) * 0.5; finalColor += noise * 0.2; gl_FragColor = vec4(finalColor, fresnel * 0.8 + 0.2); }`, transparent: true, blending: THREE.AdditiveBlending, depthWrite: false, }); 
        const coreCrystal = new THREE.Mesh(new THREE.IcosahedronGeometry(0.8, 1), crystalMaterial); 
        crystalGroup.add(coreCrystal); 
        let branches = []; 
        let crystalGrowth = 0; 
        const addBranch = () => { if (branches.length > 50) return; const branch = new THREE.Mesh(new THREE.IcosahedronGeometry(0.1 + Math.random() * 0.4, 0), crystalMaterial); const phi = Math.random() * Math.PI * 2, theta = Math.acos(Math.random() * 2 - 1), radius = 1 + Math.random() * crystalGrowth; branch.position.set( radius * Math.sin(theta) * Math.cos(phi), radius * Math.sin(theta) * Math.sin(phi), radius * Math.cos(theta) ); branch.rotation.set(Math.random(), Math.random(), Math.random()); branch.scale.set(0.01, 0.01, 0.01); crystalGroup.add(branch); branches.push({ mesh: branch, life: 0, maxLife: 0.5 + Math.random() * 1.5 }); }; 
        
        const clock = new THREE.Clock(); 
        let scrollFraction = 0, introComplete = false; 
        const introDuration = 5; 
        let currentScrollEffect = 0; 
        
        function animate() { 
            animationFrameId = requestAnimationFrame(animate); 
            if (!defaultAnimationEnabled) return; 
            
            currentScrollEffect += (scrollFraction - currentScrollEffect) * 0.05;

            const elapsedTime = clock.getElapsedTime(); 
            crystalMaterial.uniforms.time.value = elapsedTime; 
            
            let introProgress = introComplete ? 1.0 : Math.min(elapsedTime / introDuration, 1.0); 
            if (introProgress >= 1.0) introComplete = true; 
            
            crystalGrowth = Math.max(introProgress * 1.5, Math.min(currentScrollEffect * 5, 2.5)); 
            
            if (crystalGrowth > 0.1 && Math.random() > 0.9) addBranch(); 
            
            camera.position.z = 5 - Math.max(introProgress * 1.0, currentScrollEffect * 2); 
            camera.position.y = currentScrollEffect * 1; 
            
            camera.lookAt(scene.position); 
            crystalGroup.rotation.y += 0.001; 
            crystalGroup.rotation.x += 0.0005; 
            coreCrystal.scale.setScalar(1 + crystalGrowth * 0.5); 
            branches.forEach(b => { if (b.life < b.maxLife) { b.life += 0.01; b.mesh.scale.setScalar(Math.sin(b.life / b.maxLife * Math.PI * 0.5)); } }); 
            renderer.render(scene, camera); 
        } 
        
        window.addEventListener("scroll", () => { const scrollableHeight = document.body.scrollHeight - window.innerHeight; scrollFraction = scrollableHeight > 0 ? window.scrollY / scrollableHeight : 0; }); 
        window.addEventListener("resize", () => { camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });

        // --- AUTHENTICATION LOGIC ---
        async function handleAdminLogin() {
            if (auth.currentUser) {
                document.getElementById('admin-panel').classList.add('active');
                return;
            }

            const email = prompt("Enter admin email:");
            if (!email) return;

            const password = prompt("Enter admin password:");
            if (!password) return;

            try {
                await auth.signInWithEmailAndPassword(email, password);
                console.log("Admin logged in successfully");
                document.getElementById('admin-panel').classList.add('active');
            } catch (error) {
                console.error("Admin login failed:", error.message);
                alert("Login failed. Please check your email and password.");
            }
        }

        // --- APP INITIALIZATION AND NAVIGATION HANDLING ---
        function handleNavigation(e) { 
            const link = e.target.closest('a'); 
            if (!link || link.target === '_blank' || link.protocol !== window.location.protocol || link.host !== window.location.host || e.metaKey || e.ctrlKey || e.shiftKey) { return; } 
            
            const linkUrl = new URL(link.href);
            const isAnchorLink = !!linkUrl.hash;

            if (isAnchorLink) {
                e.preventDefault();
                const targetPath = linkUrl.pathname;
                const currentPath = window.location.pathname;
                const targetElementId = linkUrl.hash.substring(1);
                
                const scrollToElement = () => {
                    const element = document.getElementById(targetElementId);
                    if (element) {
                        element.scrollIntoView({ behavior: 'smooth' });
                    }
                };

                if (targetPath === currentPath) {
                    scrollToElement();
                } else {
                    window.history.pushState({}, '', targetPath);
                    routeAndRender();
                    setTimeout(scrollToElement, 100);
                }
                return;
            }

            if (linkUrl.href === window.location.href) {
                 e.preventDefault(); 
                 return;
            }

            e.preventDefault(); 
            window.history.pushState({}, '', linkUrl.pathname + linkUrl.search + linkUrl.hash); 
            routeAndRender(); 
            window.scrollTo(0, 0); 
        };
        function initStaticEventListeners() { 
            document.body.addEventListener('click', handleNavigation); 
            window.addEventListener('popstate', routeAndRender); 
            const menuToggle = document.querySelector('.menu-toggle'); 
            const navOverlay = document.querySelector('.nav-overlay'); 
            menuToggle.addEventListener('click', (e) => { e.stopPropagation(); document.body.classList.toggle('nav-is-open'); menuToggle.classList.toggle('is-active'); navOverlay.classList.toggle('is-active'); }); 
            
            navOverlay.addEventListener('click', (e) => { 
                const link = e.target.closest('a');
                if (link || e.target === navOverlay) { 
                    document.body.classList.remove('nav-is-open'); 
                    menuToggle.classList.remove('is-active'); 
                    navOverlay.classList.remove('is-active'); 
                } 
            }); 

            document.getElementById('admin-close-btn').addEventListener('click', (e) => { e.stopPropagation(); document.getElementById('admin-panel').classList.remove('active');}); 
            document.querySelector('.admin-content').addEventListener('click', e => { e.stopPropagation(); handleAdminActions(e); }); 
            document.querySelector('.admin-tabs').addEventListener('click', e => { e.stopPropagation(); if (e.target.matches('.admin-tab')) { document.querySelectorAll('.admin-tab, .tab-content').forEach(el => el.classList.remove('active')); e.target.classList.add('active'); document.querySelector(`.tab-content[data-tab-content="${e.target.dataset.tab}"]`).classList.add('active'); } }); 
        
            const footer = document.getElementById('site-footer');
            footer.innerHTML = `© 2025 Digital Craft. All rights reserved.`;
            footer.addEventListener('click', handleAdminLogin);
        }
        
        function applyCustomBackground(item = null) {
            const iframe = document.getElementById('custom-background-iframe');
            const defaultCanvas = document.getElementById('webgl-canvas');
            let customCode = item?.backgroundHtml || siteData.home?.backgroundHtml || '';

            if (customCode.trim() !== "") {
                defaultCanvas.style.display = 'none';
                iframe.style.display = 'block';
                iframe.srcdoc = customCode;
                defaultAnimationEnabled = false;
                if (animationFrameId) {
                    cancelAnimationFrame(animationFrameId);
                    animationFrameId = null;
                }
            } else {
                iframe.style.display = 'none';
                iframe.srcdoc = '';
                defaultCanvas.style.display = 'block';
                if (!defaultAnimationEnabled) {
                    defaultAnimationEnabled = true;
                    animate(); 
                }
            }
        }
        
        // --- START: ИЗМЕНЕННАЯ ФУНКЦИЯ initApp (ПУНКТ 1) ---
        function initApp() {
            // Устанавливаем флаг в false по умолчанию.
            // Это важно, чтобы prerender-сервис ждал.
            window.prerenderReady = false;

            renderMenu();
            initStaticEventListeners();
            
            // Запускаем анимацию фона сразу, она не зависит от контента
            if (defaultAnimationEnabled) {
                animate();
            }

            // Загружаем данные из Firebase
            loadData().then((freshSiteData) => {
                // 1. Сохраняем свежие данные
                siteData = freshSiteData;
                
                // 2. Рендерим страницу с актуальными данными
                routeAndRender(); 
                
                // 3. Рендерим админ-панель (она все равно скрыта)
                renderAdminPanel();

                // 4. Убираем загрузчик, так как все готово
                const loader = document.getElementById('loader');
                if (loader) loader.style.display = 'none';
                
                console.log("Data loaded from Firebase, render complete.");

                // 5. САМОЕ ВАЖНОЕ: Сообщаем сервису пререндеринга, что ВСЁ ГОТОВО!
                window.prerenderReady = true;

            }).catch(error => {
                // Обработка ошибки, если Firebase недоступен
                console.error("Failed to load initial data, showing fallback:", error);
                
                // В случае ошибки, рендерим страницу из локальных данных
                siteData = JSON.parse(JSON.stringify(initialSiteData));
                routeAndRender();
                renderAdminPanel();

                const loader = document.getElementById('loader');
                if (loader) loader.innerHTML = '<div>Error loading content. Please try again later.</div>';
                
                // Даже в случае ошибки, сообщаем, что рендеринг (аварийный) завершен
                window.prerenderReady = true;
            });
        }
        // --- END: ИЗМЕНЕННАЯ ФУНКЦИЯ initApp ---

        // --- START: ИЗМЕНЕННЫЙ СЛУШАТЕЛЬ СОБЫТИЯ (ПУНКТ 2) ---
        window.addEventListener('DOMContentLoaded', initApp);
        // --- END: ИЗМЕНЕННЫЙ СЛУШАТЕЛЬ СОБЫТИЯ ---

    </script>

    <script src="metrika.js" defer></script>
</body>
</html>